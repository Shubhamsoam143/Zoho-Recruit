client_id = "";
client_secret = "";
refresh_token = "";
jobadder_api = "https://api.jobadder.com/v2";
token_headers = Map();
token_headers.put("Content-Type","application/x-www-form-urlencoded");
token_params = Map();
token_params.put("grant_type","refresh_token");
token_params.put("client_id",client_id);
token_params.put("client_secret",client_secret);
token_params.put("refresh_token",refresh_token);
token_resp = invokeurl
[
	url :"https://id.jobadder.com/connect/token"
	type :POST
	parameters:token_params
	headers:token_headers
];
access_token = token_resp.get("access_token");
info access_token;
// Search application record
params = Map();
params.put("criteria","(Sync_with_JobAdder:equals:false)");
params.put("page",1);
params.put("per_page",30);
params.put("fields","id,$Job_Opening_Id,$Candidate_Id");
// params.put("cvid",846338000001063100);
resp_can = invokeurl
[
	url :"https://recruit.zoho.com/recruit/v2/Applications/search"
	type :GET
	parameters:params
	connection:"recruit_conn"
];
info "resp_can-----> " + resp_can;
if(resp_can != null && resp_can.get("data") != null)
{
	dataList = resp_can.get("data");
	updateList = List();
	counter = 0;
	for each  record in dataList
	{
		rec_id = record.get("id");
		candidate_id = record.get("$Candidate_Id");
		job_opening_id = record.get("$Job_Opening_Id");
		info "Application Record ID: " + rec_id;
		info "Candidate ID: " + candidate_id;
		info "Job Opening ID: " + job_opening_id;
		info "-------------------------";
		candidateResp = invokeurl
		[
			url :"https://recruit.zoho.com/recruit/v2/Candidates/" + candidate_id + "?fields=JobAdder_ID"
			type :GET
			connection:"recruit_conn"
		];
		candidateJobAdderId = "";
		if(candidateResp != null && candidateResp.get("data") != null)
		{
			candidateData = candidateResp.get("data").get(0);
			candidateId = candidateData.get("JobAdder_ID");
		}
		info "Candidate JobAdder_ID: " + candidateId;
		jobResp = invokeurl
		[
			url :"https://recruit.zoho.com/recruit/v2/Job_Openings/" + job_opening_id + "?fields=JobAdder_ID"
			type :GET
			connection:"recruit_conn"
		];
		jobOpeningJobAdderId = "";
		if(jobResp != null && jobResp.get("data") != null)
		{
			jobData = jobResp.get("data").get(0);
			jobId = jobData.get("JobAdder_ID");
		}
		info "Job Opening JobAdder_ID: " + jobId;
		// Only proceed if both IDs are available
		if(candidateId != null && candidateId != "" && jobId != null && jobId != "")
		{
			headers = Map();
			headers.put("Authorization","Bearer " + access_token);
			params = Map();
			params.put("CandidateId",candidateId);
			params.put("JobId",jobId);
			applications_resp = invokeurl
			[
				url :jobadder_api + "/applications"
				type :GET
				parameters:params
				headers:headers
			];
			// 			info applications_resp;
			applicationId = "";
			statusName = "";
			if(applications_resp != null)
			{
				items = applications_resp.get("items");
				if(items != null && items.size() > 0)
				{
					firstItem = items.get(0);
					if(firstItem.containKey("applicationId"))
					{
						applicationId = firstItem.get("applicationId");
					}
					jobAdderStatus = firstItem.get("status");
					if(jobAdderStatus != null && jobAdderStatus.containKey("name"))
					{
						statusName = jobAdderStatus.get("name");
					}
					info "Application ID  : " + applicationId;
					info "Status Name     : " + statusName;
					// Update Application Status
					if(statusName != null && statusName != "")
					{
						statusList = List();
						updateStatusMap = Map();
						updateStatusMap.put("ids",{rec_id});
						updateStatusMap.put("Application_Status",statusName);
						statusList.add(updateStatusMap);
						dataMap = Map();
						dataMap.put("data",statusList);
						// info dataMap;
						statusUpdateResp = invokeurl
						[
							url :"https://recruit.zoho.com/recruit/v2/Applications/status"
							type :PUT
							parameters:dataMap.toString()
							connection:"recruit_conn"
						];
						info "statusUpdateResp------> " + statusUpdateResp;
						// record update map
						updateMap = Map();
						updateMap.put("id",rec_id);
						updateMap.put("Job_Adder_ID",applicationId.toString());
						updateMap.put("Sync_with_JobAdder",true);
						updateList.add(updateMap);
						counter = counter + 1;
					}
				}
				else
				{
					info "No application found for given CandidateId & JobId.";
				}
			}
			else
			{
				info "Application API response is NULL.";
			}
		}
		else
		{
			info "CandidateId or JobId is empty. Skipping API call.";
		}
	}
}
else
{
	info "No records found in response";
}
// update records
updatedataMap = Map();
updatedataMap.put("data",updateList);
// info updatedataMap;
updateResp = invokeurl
[
	url :"https://recruit.zoho.com/recruit/v2/Applications"
	type :PUT
	parameters:updatedataMap.toString()
	connection:"recruit_conn"
];
info "updateResp---> " + updateResp;
info "counter-----> " + counter;
return "";
